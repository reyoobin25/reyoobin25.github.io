layout: post
title: "[SpringBoot] Spring Batch"
date: 2022-01-21 14:00:00
categories: Java&Jsp&Spring
permalink: /Java&Jsp&Spring/batch



# Why?

오피스에선 매일 12시간 동안 수십개의 스케줄을 돌리고 있고, 대용량의 로그나 통계, 상품 데이터를 보다보니 자연스레 대용량 처리에 관심이 생겼고, 비교적 최근에 출판된  [스프링 배치 완벽 가이드 2/e](http://www.yes24.com/Product/Goods/99422216) 라는 책을 찾아 읽게되었다. 1장~3장의 경우 배치가 어떤거고 스프링 배치에 전반적인 내용들과 가벼운 예시였고, 4장 ~ 10장은 각각의 기능들의 개념/사용법 (튜토리얼)및 예제를 소개하고 있다. 8장까지 읽었고, 완전하게 습득된게 아니라서 아래와같이 블로그를 나눠 포스팅하려고 한다.

첫번째 포스팅은 전반적인 요약 및 오피스 내 적용해볼 만한 점들을 정리하고, 그 다음은 각 기능들의 세부사항들을 정리해보고, 마지막으론 적용(실패가 될 수 있겠지만,,) 및 실제 단축되는 결과로 나눠 정리해보려고 한다.

## Batch Application

### Batch?

배치(Batch)는 일괄처리라는 뜻을 가지고 있다.

은행에서 생성되는 거래명세서와 퇴직 연금 명세서는 모두 배치 처리를 이용해 생성된다고 한다. 아마존(Amazon)과 같은 사이트에서 연광 상품을 추천하는 데이터 과학 모델도 배치처리로 생성되며 쇼핑몰 등 커머스쪽에서 이메일을 보낼 때 배치 처리를 통해 전송 되었을 것이라 추측한다.

매일 전날의 데이터를 집계한다고 가정했을 때, 보통은 현재 서비스 중인곳에서 처리할 것이다. 그러나 현재 서비스 중인 어플리케이션에서 전날 데이터등과 같이 큰 데이터를 읽고, 가공하고 저장한다면 해당 서버는 순식간에 CPU, I/O등의 자원을 다 써버릴 것이다. 그리고 보통 이러한 집계는 하루에 1번 정해진 시간에 처리해야하는 경우가 많다. 이 부분을 실행하기 위해서 하루중 언제라도 수행해도 되겠지만 사용자들이 가장 적게 사용하는 시간대에 수행하는 것이 가장 유리할 것이다. 또한 이러한 배치는 보안도 고려해야한다. 이렇게 배치 시스템을 만들기 위해서는 기술적으로 처리해야할 부분이 너무나 많다는 점이다. 

이러한 단발성의 대용량 데이터를 처리하는 어플리케이션을 배치 어플리케이션이라고 한다. Spring 진영에서는 이러한 배치 애플리케이션을 구성하기 위한 모듈을 지원하는데, 이것이 Spring Batch이다.

### Spring Batch?

이 책을 읽어나가기 전까진 굳이 스프링 배치를 사용하지 않더라도 chunk 기능은 사용할 수 있지 않나? 멀티 스레드로 돌리면 안되나? 라는 생각이 들었다. 이미 위에서 잠깐 언급이 되었지만 배치를 직접 구현해야 한다면 일단 기술적으로 개발자가 처리해야 할 부분이 상당하다. 또한 현재 서비스중인 애플리케이션에서 배치를 수행한다면 분명 resouce 부족을 경험하게 될 것이다. 이러한 부분에 대한 고려를 줄이고 아래 장점들을 비롯해 비지니즈 로직에 집중할 수 있도록 한 것이 스프링 배치이다. 

- **유지보수성** : 배치 처리 코드의 경우 일단 애플리케이션 코드보다 수명이 훨씬 길다. 현재 유행이나 스타일을 유지해야하는 웹 애플리케이션과는 달리, 정적 출력들을 만들어 낸다. 그렇기 때문에 큰 위험 없이 쉽게 수정이 가능한 코드로 작성되어야 한다. 스프링 배치의 경우 트랜잭션 및 커밋 횟수와 같은 것들을 애플리케이션에 제공하므로 처리가 어디까지 진행됐는가라던지 실패 시 무슨 일을 해야 하는지 관리할 필요가 없다.
- **유연성** : 메인 프레임에선 코볼을 사용하거나 고객 정보 제어 시스템(CICS)를 사용하는 것이 전부이다. 유닉스 계열에서는 C++이 있긴 하나 마땅한 프레임워크가 없어 환경에 맞춰 일일이 개발해야 한다. 이런 부분들을 JVM의 유연성으로 해결할 수 있다. 또한 시스템 간 코드를 공유할 수 있는 유연성도 제공한다. 이미 테스트 및 디버깅 된 서비스를 배치 처리에서 동일하게 바로 사용할 수 있다.
- **확장성** : 메인 프레임에서는 확장성을 위한 용량 증성이 제한된다. 병령로 작업을 수행하는 방법은 모통 단일 하드웨어 내에서 전체 프로그램을 병렬로 실행하는 것이다. 이 방식은 병렬 처리용 코드를 작성하고 유지 보수해야하며, 이로 인한 오류 처리나 상태 관리등의 어려움을 겪을 수 있다. 그러나 스프링 배치의 경우 단일 서버 내의 단일 JVM에서 배치 처리도 가능하고 사업이 확장됨에 따라 여러개의 노드로 나눠 완료할 수 있으며 클라우드 리소스를 사용해 확장해 나갈 수 있다.

## Batch Application

스프링 배치 프레임워크는 크게 세 가지 레이어로 구성되어 있다.

- application layer : 개발자가 개발한 코드, 대부분 코어 레이어와 상호작용한다.
- core layer : 배치 영역을 구성하는 실제적인 여러 컴포넌트이다.
- Infrastructure layer : ItemReader, ItemWriter를 비롯해 재시작과 관련된 문제를 해결할 수 있는 클래스와 인터페이스를 제공한다.

Core layer를 기준으로 배치 처리 아키텍처를 살펴보면 아래와 같다.

### 잡과 스텝

잡(Job) : 상태를 수집하고 이전 상태에서 다음 상태로 전환된다.

스텝(Step) : 스프링 배치에서 가장 일반적으로 상태를 보여주는 단위이다. 각 스텝은 잡을 구성하는 독립된 작업의 단위이다. 스텝에는 Tasklet, Chunk 기반으로 2가지가 있다.

- Tasklet
  - 스텝이 중지될 때까지 execute 메서드가 계속 반복해서 수행된다.
  - execute 메서드를 호출할 때마다 독립적인 트랜잭션이 얻어진다.
  - 초기화, 저장 프로시저 실행, 알림 전송과 같은 잡에서 일반적으로 사용된다.

```java
public interface Tasklet {
  @Nullable
  RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception;
}
```



- Chunk
  - 아이템 기반의 처리에 사용된다.
  - 각 Chunk 기반 스텝은 ItemReader, ItemProcessor, ItemWriter 라는 3개의 주요 부분으로 구성될 수 있다.
  - ItemProcessor 은 필수가 아니다.

### 잡 실행

잡이 실행될 때 스프링 배치의 많은 컴포넌트는 탄력성(resiliency)을 제공하기 위해 서로 상호작용을 한다.

- JobRepository 
  - 다양한 배치 수행과 관련된 수치 데이터(시작 시간, 종료 시간, 상태, 읽기/쓰기 횟수 등)와 잡의 상태를 유지 및 관리한다. 
  - 일반적으로 관계형 데이터베이스를 사용하며 스프링 배치 내의 대부분의 주요 컴포넌트가 공유한다.
  - 실행된 스텝, 현재 상태, 읽은 아이템 및 처리된 아이템 수 등이 모두 JobRepository 에 저장된다.
- JobLauncher
  - 잡을 실행하는 역할을 담당한다. Job.execute 을 호출하는 역할이다.
  - 잡의 재실행 가능 여부 검증, 잡의 실행 방법(현재 thread에서 수행할 지 thread pool을 통해 실행할지), 파라미터 유효성 검증 등을 수행한다.
  -  스프링 부트의 환경에서는 부트가 잡을 즉시 시작하는 기능을 제공하므로, 일반적으로 직접 다룰 필요가 없는 컴포넌트다.
  -  잡을 실행하면 해당 잡은 구성된 목록에 따라 각 스텝을 실행한다. 각 스텝이 실행되면 JobRepository는 현재 상태로 갱신된다.

### 잡 또는 스텝의 실행완료

실행 완료 시,  JobRepository 내에 있는 JobExecution 또는 StepExecution 이 최종 상태로 업데이트 된다.

- JobInstance
  - 스프링 배치 잡의 논리적인 실행이다. 
  - 잡을 각 다른 파라미터로 실행될 때마다 새로운 JobInstance 가 생성된다.
  - JobInstance 는 여러개의 JobExecution 을 가질 수 있다.
- JobExecution
  - 스프링 배치 잡(Job)의 실제 실행을 의미한다.
  - 잡을 구동할 때마다 매번 새로운 JobExecution 을 얻게된다.
- StepExecution
  - 스프링 배치 스텝(Step) 의 실제 실행을 의미한다.

### 배치 처리

가장 단순한 처리는 잡 내의 스텝을 단일 스레드에서 실행하는 것이다. 그러나 스프링 배치는 실 사례에 필요한 다양한 병렬화 방법도 제공하고 있다.

- 다중 스레드 스텝을 통한 작업 분할
- 전체 스텝의 병렬 실행
- 비동기 ItemProcessor / ItemWriter
- 원격 청킹
- 파티셔닝



## 목표

책을 읽고 간단하게 요약해서 정리해 본 내용들은 위와같다. 책을 읽게된 목적은 결국 우리 서비스에 어딘가 써먹거나 방향성을 제시한다면, 가장 베스트라 생각이들었다. 물론 어울리지 않을수도 있고, 이론과는 다르게 좋은 결과가 나오지 않을 수 있다. 그러나 지금까지 읽었을 때 녹여 볼 만한 부분은 없는지 고민을 해보게 되었다.

1) 스케줄 잡 Refactoring

현재 오피스 스케줄의 경우 전 날에 대한 로그 혹은 통계 데이터를 생성하는 스케줄, 카테고리별 상품별 상태를 확인해서 데이터를 삭제하거나 링크/링크해제 하는 스케줄이 빼곡히 존재하고 있다. 스케줄은 단일 스레드로 진행되고 있는데, 이 부분을 배치에서 제공하는 다중 스레드로 변경하는 것도 좋을것 같다는 생각이 들었다. 

한 스케줄을 예시로 들어보자. 

A사+B사의 등록된 데이터를 조회, 해당 데이터를 통해 타사의 데이터 파싱, 파싱된 데이터로 업데이트하는 구조의 스케줄이 있다. 해당 스케줄의 경우, 실패 시 전체 재실행되는 스케줄이다. 이 스케줄에서 생각해본 부분은 A사에 등록된 데이터 조회와 B사에 등록된 데이터를 분리해서 각각 조회를 한다면, 그 이후의 로직은 서로 연관없이 진행될 수 있을 것 같다는 생각이 들었다. 병렬 스텝으로 진행시키고, 중간에 실패가 뜨면 각 스텝별로 retry를 하거나 따로 기록을 하도록 처리 하는 것이다.

<img src = "/img/22_3.PNG" class="middle-image"/>

2) 대용량 일회성 일괄 처리 위임

최근에 약 50만건정도 하는 데이터를 일괄 삭제하는 일회성 잡을 진행한 적이 있다. 해당  잡은 서비스에 문제가 될 수 있다고 판단되어 몇일에 나눠 진행되었다. 이러한 대량 데이터 처리를 위임하여 아래와 같이 처리한다면, 서비스 중인 애플리케이션에 영향을 주지 않고, 더 빠른 결과를 도출해 낼 수 있지 않을까 생각했다.

<img src = "/img/22_2.PNG" class="middle-image"/>



